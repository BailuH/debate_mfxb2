<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—æ³•åº­ - Digital Court Demo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        @keyframes pulse-border {
            0%, 100% { border-color: #10b981; }
            50% { border-color: #34d399; }
        }
        .connected-pulse { animation: pulse-border 2s infinite; }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animate { animation: fade-in 0.3s ease-out; }

        .role-judge { border-left-color: #f59e0b; background: linear-gradient(90deg, rgba(245,158,11,0.1) 0%, transparent 100%); }
        .role-prosecutor { border-left-color: #3b82f6; background: linear-gradient(90deg, rgba(59,130,246,0.1) 0%, transparent 100%); }
        .role-defendant { border-left-color: #10b981; background: linear-gradient(90deg, rgba(16,185,129,0.1) 0%, transparent 100%); }
        .role-defense_attorney { border-left-color: #f97316; background: linear-gradient(90deg, rgba(249,115,22,0.1) 0%, transparent 100%); }
        .role-clerk { border-left-color: #6b7280; background: linear-gradient(90deg, rgba(107,114,128,0.1) 0%, transparent 100%); }
        .role-system { border-left-color: #8b5cf6; background: linear-gradient(90deg, rgba(139,92,246,0.1) 0%, transparent 100%); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="app" v-cloak>
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-2xl">âš–ï¸</div>
                    <div>
                        <h1 class="text-xl font-bold text-white">æ•°å­—æ³•åº­ - Digital Court</h1>
                        <p class="text-sm text-gray-400">AI é©±åŠ¨çš„åº­å®¡æ¨¡æ‹Ÿå¹³å°</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- è¿æ¥çŠ¶æ€ -->
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm"
                         :class="connected ? 'bg-green-900/50 text-green-400 connected-pulse border border-green-700' : 'bg-gray-700 text-gray-400'">
                        <span class="w-2 h-2 rounded-full" :class="connected ? 'bg-green-400' : 'bg-gray-500'"></span>
                        {{ connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}
                    </div>
                    <!-- ä¼šè¯ID -->
                    <div v-if="threadId" class="text-xs text-gray-500 font-mono">
                        Thread: {{ threadId.slice(0, 8) }}...
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="lg:col-span-1 space-y-4">
                <!-- æ“ä½œé¢æ¿ -->
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                    <h2 class="text-sm font-semibold text-gray-400 mb-3 flex items-center gap-2">
                        <span>ğŸ®</span> æ§åˆ¶é¢æ¿
                    </h2>

                    <!-- å¼€å§‹/åœæ­¢æŒ‰é’® -->
                    <button @click="toggleTrial"
                            :disabled="!connected || (trialStarted && !trialCompleted)"
                            class="w-full py-3 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2"
                            :class="!connected ? 'bg-gray-700 text-gray-500 cursor-not-allowed' :
                                    trialStarted && !trialCompleted ? 'bg-yellow-600 hover:bg-yellow-500 text-white' :
                                    'bg-blue-600 hover:bg-blue-500 text-white'">
                        <span v-if="!connected">ğŸ”Œ è¯·å…ˆè¿æ¥</span>
                        <span v-else-if="!trialStarted">â–¶ï¸ å¼€å§‹åº­å®¡</span>
                        <span v-else-if="trialCompleted">ğŸ”„ é‡æ–°å¼€å§‹</span>
                        <span v-else>â¸ï¸ åº­å®¡è¿›è¡Œä¸­...</span>
                    </button>

                    <!-- æ¸…ç©ºæ¶ˆæ¯ -->
                    <button @click="clearMessages"
                            class="w-full mt-2 py-2 px-4 rounded-lg text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 transition-colors">
                        ğŸ—‘ï¸ æ¸…ç©ºæ¶ˆæ¯
                    </button>
                </div>

                <!-- è¿›åº¦é¢æ¿ -->
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                    <h2 class="text-sm font-semibold text-gray-400 mb-3 flex items-center gap-2">
                        <span>ğŸ“Š</span> åº­å®¡è¿›åº¦
                    </h2>

                    <!-- è¿›åº¦æ¡ -->
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>è¿›åº¦</span>
                            <span>{{ progress.toFixed(1) }}%</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full transition-all duration-500 ease-out"
                                 :class="progressBarColor"
                                 :style="{ width: progress + '%' }">
                            </div>
                        </div>
                    </div>

                    <!-- å½“å‰é˜¶æ®µ -->
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">å½“å‰é˜¶æ®µ</span>
                            <span class="font-medium" :class="phaseColor">{{ phaseDisplay }}</span>
                        </div>

                        <!-- è½®æ¬¡ä¿¡æ¯ -->
                        <div v-if="rounds.pros_question_rounds !== undefined" class="space-y-1 pt-2 border-t border-gray-700">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">æé—®è½®æ¬¡</span>
                                <span class="text-gray-300">{{ rounds.pros_question_rounds }} / 3</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">ä¸¾è¯è½®æ¬¡</span>
                                <span class="text-gray-300">{{ rounds.pros_evidence_rounds }} / 3</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">è¾©è®ºè½®æ¬¡</span>
                                <span class="text-gray-300">{{ rounds.pros_focus_rounds }} / 2</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- äº‰è®®ç„¦ç‚¹ -->
                <div v-if="focus.length > 0" class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                    <h2 class="text-sm font-semibold text-gray-400 mb-3 flex items-center gap-2">
                        <span>ğŸ¯</span> äº‰è®®ç„¦ç‚¹ ({{ focus.length }})
                    </h2>
                    <div class="space-y-2">
                        <div v-for="(item, idx) in focus" :key="idx"
                             class="text-sm p-2 rounded bg-gray-700/50 text-gray-300">
                            <span class="text-amber-400 mr-2">{{ idx + 1 }}.</span>{{ item }}
                        </div>
                    </div>
                </div>

                <!-- æ¡ˆä»¶ä¿¡æ¯ -->
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                    <h2 class="text-sm font-semibold text-gray-400 mb-3 flex items-center gap-2">
                        <span>ğŸ“‹</span> æ¡ˆä»¶ä¿¡æ¯
                    </h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">æ¡ˆä»¶ç¼–å·</span>
                            <span class="text-gray-300">{{ trialData.meta.case_id }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">æ³•é™¢</span>
                            <span class="text-gray-300">{{ trialData.meta.court_name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">è¢«å‘Šäºº</span>
                            <span class="text-gray-300">{{ trialData.meta.defendant_name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">ç½ªå</span>
                            <span class="text-red-400">{{ trialData.meta.crime }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ¶ˆæ¯åŒºåŸŸ -->
            <div class="lg:col-span-3 space-y-4">
                <!-- æ¶ˆæ¯æµ -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-gray-400 flex items-center gap-2">
                            <span>ğŸ’¬</span> åº­å®¡è®°å½•
                            <span v-if="messages.length > 0" class="text-gray-500">({{ messages.length }} æ¡)</span>
                        </h2>
                        <button @click="scrollToBottom" class="text-xs text-blue-400 hover:text-blue-300">
                            â¬‡ï¸ æ»šåˆ°åº•éƒ¨
                        </button>
                    </div>
                    <div ref="messageContainer" class="h-[400px] overflow-y-auto p-4 space-y-3 scrollbar-thin">
                        <div v-if="messages.length === 0" class="h-full flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <div class="text-4xl mb-2">âš–ï¸</div>
                                <p>ç‚¹å‡»"å¼€å§‹åº­å®¡"å¼€å§‹æ¨¡æ‹Ÿ</p>
                            </div>
                        </div>
                        <div v-for="(msg, idx) in messages" :key="idx"
                             class="message-animate p-3 rounded-r-lg border-l-4"
                             :class="getRoleClass(msg)">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-medium text-sm" :class="getRoleTextColor(msg)">
                                    {{ getRoleName(msg) }}
                                </span>
                                <span class="text-xs text-gray-500">{{ formatTime(msg.timestamp) }}</span>
                                <span v-if="msg.node_name" class="text-xs text-gray-600 font-mono">
                                    [{{ msg.node_name }}]
                                </span>
                            </div>
                            <div class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap">{{ msg.content }}</div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ä¸­æ–­å“åº”åŒº -->
                <div v-if="interrupt" class="bg-gray-800 rounded-xl border border-blue-700 overflow-hidden">
                    <div class="px-4 py-3 bg-blue-900/30 border-b border-blue-700/50">
                        <h2 class="text-sm font-semibold text-blue-400 flex items-center gap-2">
                            <span class="animate-pulse">ğŸ””</span> éœ€è¦æ‚¨çš„å“åº”
                        </h2>
                    </div>
                    <div class="p-4">
                        <p class="text-gray-200 mb-4">{{ interrupt.prompt }}</p>

                        <!-- boolean è¾“å…¥ -->
                        <div v-if="interrupt.input_type === 'boolean'" class="flex gap-3">
                            <button @click="sendInput(true)"
                                    class="flex-1 py-3 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-medium transition-colors">
                                âœ… æ˜¯
                            </button>
                            <button @click="sendInput(false)"
                                    class="flex-1 py-3 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white font-medium transition-colors">
                                âŒ å¦
                            </button>
                        </div>

                        <!-- string è¾“å…¥ -->
                        <div v-else-if="interrupt.input_type === 'string'" class="flex gap-2">
                            <input v-model="stringInput" type="text"
                                   @keyup.enter="sendInput(stringInput)"
                                   placeholder="è¯·è¾“å…¥æ‚¨çš„å›ç­”..."
                                   class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                            <button @click="sendInput(stringInput)"
                                    :disabled="!stringInput.trim()"
                                    class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">
                                å‘é€
                            </button>
                        </div>

                        <!-- evidence è¾“å…¥ -->
                        <div v-else-if="interrupt.input_type === 'evidence'" class="space-y-3">
                            <div v-if="interrupt.node_name !== 'defense_show_evidence'" class="flex gap-2 items-center mb-3">
                                <span class="text-sm text-gray-400">ä¸¾è¯æ¨¡å¼:</span>
                                <select v-model="evidenceShowType" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="single">å•ä¸€è¯æ®</option>
                                    <option value="union">è”åˆè¯æ®</option>
                                    <option value="quit">æ”¾å¼ƒä¸¾è¯</option>
                                </select>
                            </div>
                            <div v-else class="flex gap-2 items-center mb-3">
                                <span class="text-sm text-gray-400">ä¸¾è¯æ¨¡å¼:</span>
                                <select v-model="evidenceShowType" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="single">å•ä¸€è¯æ®</option>
                                    <option value="union">è”åˆè¯æ®</option>
                                </select>
                            </div>
                            <div v-if="evidenceShowType !== 'quit'" class="max-h-48 overflow-y-auto border border-gray-700 rounded-lg p-2 space-y-2">
                                <label v-for="ev in availableEvidence" :key="ev.id"
                                       class="flex items-start gap-3 p-2 rounded hover:bg-gray-700/50 cursor-pointer">
                                    <input type="checkbox" :value="ev" v-model="selectedEvidence"
                                           class="mt-1 w-4 h-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm text-white">{{ ev.name }}</div>
                                        <div class="text-xs text-gray-400 mt-1">{{ ev.content.slice(0, 80) }}...</div>
                                    </div>
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <input v-if="evidenceShowType !== 'quit'" v-model="evidenceMessage" type="text"
                                       placeholder="ä¸¾è¯è¯´æ˜ï¼ˆå¯é€‰ï¼‰..."
                                       class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                                <button @click="sendEvidenceInput"
                                        class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition-colors">
                                    æäº¤è¯æ®
                                </button>
                            </div>
                        </div>

                        <!-- é€‰é¡¹è¾“å…¥ -->
                        <div v-else-if="interrupt.options && interrupt.options.length > 0" class="space-y-2">
                            <button v-for="option in interrupt.options" :key="option"
                                    @click="sendInput(option)"
                                    class="w-full text-left px-4 py-3 rounded-lg bg-gray-700 hover:bg-gray-600 text-white transition-colors">
                                {{ option }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å®ŒæˆçŠ¶æ€ -->
                <div v-if="trialCompleted" class="bg-green-900/30 border border-green-700 rounded-xl p-6 text-center">
                    <div class="text-4xl mb-3">ğŸ‰</div>
                    <h3 class="text-xl font-bold text-green-400 mb-2">åº­å®¡å·²å®Œæˆ</h3>
                    <p class="text-gray-400">æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæ¯•ï¼Œç‚¹å‡»"é‡æ–°å¼€å§‹"å¯è¿›è¡Œæ–°çš„åº­å®¡æ¨¡æ‹Ÿ</p>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 px-6 py-2">
            <div class="max-w-7xl mx-auto flex items-center justify-between text-xs text-gray-500">
                <div>
                    å½“å‰èŠ‚ç‚¹: <span class="text-gray-300 font-mono">{{ currentNodeName || '-' }}</span>
                </div>
                <div class="flex items-center gap-4">
                    <span>æ¶ˆæ¯æ•°: {{ messages.length }}</span>
                    <span v-if="lastMessageTime">æœ€åæ›´æ–°: {{ lastMessageTime }}</span>
                </div>
            </div>
        </footer>

        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="fixed top-4 right-4 bg-red-900/90 border border-red-700 rounded-lg p-4 max-w-md z-50">
            <div class="flex items-start gap-3">
                <span class="text-red-400">âš ï¸</span>
                <div>
                    <h4 class="font-medium text-red-400">å‘ç”Ÿé”™è¯¯</h4>
                    <p class="text-sm text-gray-300 mt-1">{{ error }}</p>
                </div>
                <button @click="error = null" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, nextTick, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                // WebSocket è¿æ¥
                const ws = ref(null);
                const connected = ref(false);
                const threadId = ref(null);
                const reconnectAttempts = ref(0);
                const reconnectTimer = ref(null);

                // åº­å®¡çŠ¶æ€
                const trialStarted = ref(false);
                const trialCompleted = ref(false);
                const messages = ref([]);
                const currentPhase = ref('');
                const progress = ref(0);
                const focus = ref([]);
                const rounds = ref({});
                const currentNodeName = ref('');

                // ç”¨æˆ·è¾“å…¥
                const interrupt = ref(null);
                const stringInput = ref('');
                const selectedEvidence = ref([]);
                const evidenceShowType = ref('single');
                const evidenceMessage = ref('');

                // UI å¼•ç”¨
                const messageContainer = ref(null);
                const error = ref(null);
                const lastMessageTime = ref('');

                // é¢„è®¾æµ‹è¯•æ•°æ®
                const trialData = ref({
                    meta: {
                        abstract: "2016å¹´3æœˆ24æ—¥ï¼Œç¨‹æŒ¯è´¤é¥®é…’åé©¾é©¶æ— å·ç‰Œç”µåŠ¨è½¦æ­è½½é†‰é…’çš„å¼ é¾™ä¸Šè·¯è¡Œé©¶ï¼Œä¸åœåœ¨è·¯è¾¹çš„å°è´§è½¦å‘ç”Ÿç¢°æ’ã€‚ç¨‹æŒ¯è´¤ä¸å¼ é¾™æ‘”å€’åœ¨åœ°ï¼Œéšåï¼Œç¨‹æŒ¯è´¤å°†å¼ é¾™é€è‡³æ—…åº—æˆ¿é—´å…¥ä½åç¦»å¼€ã€‚æ¬¡æ—¥ï¼Œæ—…åº—åº—ä¸»å‘ç°å¼ é¾™å¼‚æ ·åæŠ¥è­¦ã€‚å¼ é¾™ç»åŒ»é™¢æŠ¢æ•‘æ— æ•ˆæ­»äº¡ã€‚åç»æ³•åŒ»é‰´å®šå¼ é¾™ç¬¦åˆé’æ€§æš´åŠ›ä½œç”¨å¤´éƒ¨è‡´ä¸¥é‡é¢…è„‘æŸä¼¤æ­»äº¡ã€‚",
                        prosecutor_title: "æ±Ÿå±±å¸‚åŒ—æ¹–åŒºäººæ°‘æ£€å¯Ÿé™¢",
                        prosecutor_name: "ç‹æŸ",
                        statement_charge: "è¢«å‘Šäººç¨‹æŒ¯è´¤ï¼Œç”·ï¼Œ1989å¹´9æœˆ23æ—¥å‡ºç”Ÿï¼Œèº«ä»½è¯å·ç 456878198909236532ï¼Œæ±‰æ—ï¼Œåˆä¸­æ–‡åŒ–ï¼Œæˆ·ç±æ‰€åœ¨åœ°æµ·å®çœæ­¦é¸£å¸‚å½©äº‘å¿ç¦„æ°´ä¹¡æ¸…æ¹–åŒºé›·æ‰“æµ¦å››å··8å·ï¼Œç°ä½æ±Ÿå±±å¸‚åŒ—æ¹–åŒºå°çŸ³é•‡åç››ç”µå­å‚å®¿èˆã€‚å› æ¶‰å«Œè¿‡å¤±è‡´äººæ­»äº¡ç½ªï¼Œäº2016å¹´3æœˆ25æ—¥è¢«æ±Ÿå±±å¸‚å…¬å®‰å±€åŒ—æ¹–åˆ†å±€åˆ‘äº‹æ‹˜ç•™ï¼ŒåŒå¹´4æœˆ4æ—¥ç»æœ¬é™¢æ‰¹å‡†é€®æ•ï¼Œç°ç¾æŠ¼äºåŒ—æ¹–åŒºçœ‹å®ˆæ‰€ã€‚\n\næœ¬æ¡ˆç”±æ±Ÿå±±å¸‚å…¬å®‰å±€åŒ—æ¹–åˆ†å±€ä¾¦æŸ¥ç»ˆç»“ï¼Œä»¥è¢«å‘Šäººç¨‹æŒ¯è´¤æ¶‰å«Œè¿‡å¤±è‡´äººæ­»äº¡ç½ªï¼Œäº2016å¹´4æœˆ6æ—¥ç§»é€æœ¬é™¢å®¡æŸ¥èµ·è¯‰ã€‚æœ¬é™¢å—ç†åï¼Œå·²ä¾æ³•å‘ŠçŸ¥è¢«å‘Šäººæœ‰æƒå§”æ‰˜è¾©æŠ¤äººï¼Œå‘ŠçŸ¥è¢«å®³äººè¿‘äº²å±æœ‰æƒå§”æ‰˜è¯‰è®¼ä»£ç†äººï¼Œä¾æ³•è®¯é—®äº†è¢«å‘Šäººï¼Œå¬å–äº†è¾©æŠ¤äººåŠè¢«å®³äººè¿‘äº²å±çš„æ„è§ï¼Œå®¡æŸ¥äº†å…¨éƒ¨æ¡ˆä»¶ææ–™ã€‚\n\nç»ä¾æ³•å®¡æŸ¥æŸ¥æ˜ï¼š\n2016å¹´3æœˆ24æ—¥22æ—¶è®¸ï¼Œè¢«å‘Šäººç¨‹æŒ¯è´¤ä¸å¼ é¾™ï¼ˆæ­»è€…ï¼‰ç­‰äººåœ¨æ±Ÿå±±å¸‚åŒ—æ¹–åŒºå°çŸ³é•‡æ½­å¤´ç™½èŠ¸æ‘ä¸€çƒ§çƒ¤åº—é¥®é…’ï¼Œå››äººå…±é¥®ç”¨ä¸‰æ‰å•¤é…’ï¼ˆæ¯æ‰3å‡ï¼‰ã€‚è‡³æ¬¡æ—¥å‡Œæ™¨2æ—¶è®¸ï¼Œç¨‹æŒ¯è´¤åœ¨æ˜çŸ¥è‡ªèº«é¥®é…’çš„æƒ…å†µä¸‹ï¼Œé©¾é©¶å¤œç¯ç¼ºå¤±çš„æ— å·ç‰Œç”µåŠ¨è‡ªè¡Œè½¦ï¼Œæ­è½½å·²é†‰é…’çš„å¼ é¾™è¿”å›ä½æ‰€ï¼Œå› è½¦é€Ÿè¿‡å¿«ä¸”æœªæ³¨æ„è§‚å¯Ÿè·¯å†µï¼Œäºå°æ½­é«˜ä¸­é™„è¿‘æ–œå¡è·¯å£ä¸åœæ”¾åœ¨è·¯ä¸­çš„å°è´§è½¦å‘ç”Ÿç¢°æ’ï¼ŒäºŒäººæ‘”å€’åœ¨åœ°ï¼Œå¼ é¾™çš„å¤´éƒ¨ä¸å°è´§è½¦å‘ç”Ÿç¢°æ’ã€‚äº‹æ•…å‘ç”Ÿåï¼Œç¨‹æŒ¯è´¤å‘ç°å¼ é¾™å€’åœ°åæ— ååº”ï¼Œä½†æœªé‡‡å–ä»»ä½•åŒ»ç–—æ•‘åŠ©æªæ–½ï¼Œä»…å°†å…¶é€è‡³å°æ½­æ±½è½¦ç«™å¯¹é¢å‡ºç§Ÿå±‹åå¾„ç›´ç¦»å¼€ã€‚æ¬¡æ—¥ä¸Šåˆ11æ—¶è®¸ï¼Œå¼ é¾™è¢«æ—…åº—åº—ä¸»é»„æ™¨å‘ç°å¼‚å¸¸ï¼Œç»åŒ»ç”Ÿåˆ°åœºç¡®è®¤å·²æ­»äº¡ï¼Œç»æ³•åŒ»é‰´å®šå¼ é¾™ç¬¦åˆé’æ€§æš´åŠ›ä½œç”¨å¤´éƒ¨è‡´ä¸¥é‡é¢…è„‘æŸä¼¤æ­»äº¡ã€‚\n\nè®¤å®šä¸Šè¿°çŠ¯ç½ªäº‹å®çš„è¯æ®å¦‚ä¸‹ï¼š\n1.è¯äººè¯è¨€ï¼šè¯äººé»„æ™¨ã€æ½˜å½©äº‘ã€åˆ˜æµ·æœˆçš„è¯è¨€ï¼›\n2.è¢«å‘Šäººä¾›è¿°å’Œè¾©è§£ï¼šè¢«å‘Šäººç¨‹æŒ¯è´¤çš„ä¾›è¿°å’Œè¾©è§£ï¼›\n3.é‰´å®šæ„è§ï¼šæ³•åŒ»å­¦å°¸ä½“æ£€éªŒé‰´å®šä¹¦ï¼›\n4.å‹˜éªŒç¬”å½•ï¼šç°åœºå‹˜éªŒç¬”å½•ã€‚\n\næœ¬é™¢è®¤ä¸ºï¼Œè¢«å‘Šäººç¨‹æŒ¯è´¤åœ¨æ˜çŸ¥é¥®é…’åé©¾é©¶èƒ½åŠ›ä¼šä¸‹é™çš„æƒ…å†µä¸‹ï¼Œé†‰é…’é©¾é©¶ç”µåŠ¨è½¦è½½è¢«å®³äººé«˜é€Ÿè¡Œé©¶å¯¼è‡´äº‹æ•…å‘ç”Ÿï¼Œå¹¶åœ¨è¢«å®³äººå› äº‹æ•…å¤±å»æ„è¯†åç–äºæ£€æŸ¥ä¸”æœªåŠæ—¶é€åŒ»ï¼Œå¯¼è‡´è¢«å®³äººå› æœªåŠæ—¶è·å¾—æ•‘æ²»è€Œæ­»äº¡ï¼Œå…¶è¡Œä¸ºå·²è§¦çŠ¯ã€Šä¸­åäººæ°‘å…±å’Œå›½åˆ‘æ³•ã€‹ç¬¬äºŒç™¾ä¸‰åä¸‰æ¡ä¹‹è§„å®šï¼ŒçŠ¯ç½ªäº‹å®æ¸…æ¥šï¼Œè¯æ®ç¡®å®ã€å……åˆ†ï¼Œåº”å½“ä»¥è¿‡å¤±è‡´äººæ­»äº¡ç½ªè¿½ç©¶å…¶åˆ‘äº‹è´£ä»»ã€‚æ ¹æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½åˆ‘äº‹è¯‰è®¼æ³•ã€‹ç¬¬ä¸€ç™¾ä¸ƒåäºŒæ¡ä¹‹è§„å®šï¼Œæœ¬é™¢ä¾æ³•æèµ·å…¬è¯‰ï¼Œè¯·ä¾æ³•åˆ¤å¤„ã€‚\n\næ­¤è‡´\næ±Ÿå±±å¸‚åŒ—æ¹–åŒºäººæ°‘æ³•é™¢",
                        crime: "è¿‡å¤±è‡´äººæ­»äº¡ç½ª",
                        defendant_name: "ç¨‹æŒ¯è´¤",
                        defendant_former_name: null,
                        defendant_birthdate: "1989-09-23",
                        defendant_birthplace: "æµ·å®çœæ­¦é¸£å¸‚å½©äº‘å¿",
                        defendant_ethnicity: "æ±‰æ—",
                        defendant_education: "åˆä¸­",
                        defendant_occupation: "å·¥äºº",
                        defendant_employer: "åç››ç”µå­å‚",
                        defendant_residence: "æµ·å®çœæ±Ÿå±±å¸‚åŒ—æ¹–åŒºå°çŸ³é•‡åç››ç”µå­å‚å®¿èˆ",
                        defendant_ID_number: "456878198909236532",
                        defendant_legal_record: "æ— ",
                        detention_date: "2016-03-25",
                        indictment_date: "2016-04-20",
                        attorney_name: "ææŸï¼ˆåŒ—äº¬å…¸è°Ÿå¾‹å¸ˆäº‹åŠ¡æ‰€ï¼‰",
                        court_name: "æ±Ÿå±±å¸‚åŒ—æ¹–åŒºäººæ°‘æ³•é™¢",
                        judge_name: "å¼ å®¡åˆ¤é•¿",
                        judge_name_2: "ç‹é™ªå®¡å‘˜",
                        clerk_name: "æä¹¦è®°å‘˜",
                        case_id: "æ±Ÿå…¬åŒ—è¯‰å­—[2016]03449å·"
                    },
                    evidence_list: [
                        { id: "E001", name: "ä¸€å·æ¡ˆä¾‹è¯´æ˜", content: "æœ¬æ¡ˆæ§æ–¹ä»¥ç¨‹æŒ¯è´¤æ„æˆè¿‡å¤±è‡´äººæ­»äº¡ç½ªèµ·è¯‰ï¼Œè¾©æ–¹è¿›è¡Œæ— ç½ªè¾©æŠ¤ï¼›åº­å®¡å‡†å¤‡éµå¾ªæ¡ˆæƒ…æ¦‚è¦æ‰€è¿°ç«‹åœºï¼›åªæ¶‰åŠç¨‹æŒ¯è´¤ä¸€äººä¸€æ¡ˆï¼Œæ— åˆ‘äº‹é™„å¸¦æ°‘äº‹è¯‰è®¼ï¼›ç¨‹åºåˆæ³•ï¼Œæ— è¿æ³•è¡Œä¸ºï¼›è¯æ®åŸå§‹ä¸”å–è¯åˆæ³•ï¼›åœ°åäººåè™šæ‹Ÿã€‚", provider: "prosecutor" },
                        { id: "E002", name: "æ¡ˆæƒ…æ¦‚è¦", content: "å…¬è¯‰æœºå…³æ±Ÿå±±å¸‚åŒ—æ¹–åŒºäººæ°‘æ£€å¯Ÿé™¢ï¼Œè¢«å‘Šäººç¨‹æŒ¯è´¤ï¼›2016å¹´3æœˆ24æ—¥ç¨‹æŒ¯è´¤é¥®é…’åé©¾æ— å·ç‰Œç”µåŠ¨è½¦æ­è½½é†‰é…’å¼ é¾™ï¼Œä¸è·¯è¾¹å°è´§è½¦ç¢°æ’ï¼Œåé€å¼ é¾™è‡³æ—…åº—ç¦»å¼€ï¼›æ¬¡æ—¥å¼ é¾™æ­»äº¡ï¼Œç»é‰´å®šä¸ºé’æ€§æš´åŠ›è‡´ä¸¥é‡é¢…è„‘æŸä¼¤æ­»äº¡ã€‚", provider: "prosecutor" },
                        { id: "E003", name: "èµ·è¯‰æ„è§ä¹¦", content: "æ±Ÿå…¬åŒ—è¯‰å­—[2016]03449å·ï¼›å«Œç–‘äººç¨‹æŒ¯è´¤åŸºæœ¬ä¿¡æ¯ï¼›æ¡ˆæƒ…ï¼š2016å¹´3æœˆ24æ—¥æ™šä¸å¼ é¾™å–é…’åé©¾ç”µåŠ¨è½¦ç¢°æ’å°è´§è½¦ï¼Œæœªé€åŒ»è€Œé€è‡³å‡ºç§Ÿå±‹ï¼›æ¬¡æ—¥å¼ é¾™æ­»äº¡ï¼›è¯æ®åŒ…æ‹¬ä¾›è¿°ã€ç°åœºå‹˜éªŒã€æ³•åŒ»é‰´å®šã€è¯è¨€ï¼›æ¶‰å«Œè¿‡å¤±è‡´äººæ­»äº¡ç½ªã€‚", provider: "prosecutor" },
                        { id: "E004", name: "å¸¸ä½äººå£æˆ·ç±èµ„æ–™", content: "ç¨‹æŒ¯è´¤ï¼Œç”·ï¼Œ1989å¹´9æœˆ23æ—¥ç”Ÿï¼Œèº«ä»½è¯456878198909236532ï¼Œæ±‰æ—ï¼Œæˆ·ç±æµ·å®çœæ­¦é¸£å¸‚å½©äº‘å¿ç¦„æ°´ä¹¡æ¸…æ¹–åŒºé›·æ‰“æµ¦å››å··8å·ã€‚", provider: "prosecutor" },
                        { id: "E005", name: "ç°åœºå‹˜éªŒç¬”å½•", content: "æ±Ÿå…¬(åŒ—)å‹˜[2016]7547å·ï¼›å‹˜éªŒå…´æ—ºç¾é£Ÿåº—è¥¿ä¾§æ—…é¦†208æˆ¿é—´åŠç›¸å…³ç°åœºï¼Œå‘ç°å°¸ä½“ã€è¡€è¿¹ã€åˆ®æ“¦ç—•è¿¹ï¼›åŒ…æ‹¬ç¤ºæ„å›¾å’Œç…§ç‰‡ã€‚", provider: "prosecutor" },
                        { id: "E006", name: "æ³•åŒ»å­¦å°¸ä½“æ£€éªŒé‰´å®šä¹¦", content: "æ±Ÿå…¬åŒ—(å¸)é‰´(æ³•)[2016]2478å·ï¼›å¼ é¾™å°¸ä½“æ£€éªŒï¼šå¤šå¤„æŒ«æ“¦ä¼¤ã€å¤´çš®ä¸‹è¡€è‚¿ã€é¢…éª¨éª¨æŠ˜ã€ç¡¬è†œä¸‹è¡€è‚¿ã€è„‘ç–å½¢æˆï¼›æ­»å› é’æ€§æš´åŠ›è‡´ä¸¥é‡é¢…è„‘æŸä¼¤æ­»äº¡ã€‚", provider: "prosecutor" },
                        { id: "E007", name: "é»„æ™¨è¯¢é—®ç¬”å½•", content: "é»„æ™¨ï¼ˆæˆ¿ä¸œï¼‰æè¿°ï¼š2016å¹´3æœˆ25æ—¥å‡Œæ™¨ä¸‰ç”·ä¸€å¥³ç§Ÿ208æˆ¿ï¼Œé†‰é…’ç”·å­å…¥ä½åå…¶ä»–äººç¦»å¼€ï¼›ä¸Šåˆå‘ç°ç”·å­å¼‚æ ·ï¼ŒæŠ¥è­¦ï¼›åŒ»ç”Ÿç¡®è®¤æ­»äº¡ã€‚", provider: "prosecutor" },
                        { id: "E008", name: "æ½˜å½©äº‘è¯¢é—®ç¬”å½•", content: "æ½˜å½©äº‘ï¼ˆæˆ¿ä¸œå¦»å­ï¼‰æè¿°ï¼šä¸ŠåˆæŸ¥æˆ¿å‘ç°208æˆ¿å®¢äººæ— ååº”ï¼Œé€šçŸ¥ä¸ˆå¤«ï¼›ä¸‰äººé€å®¢å…¥ä½ï¼Œæ— äººç…§é¡¾ï¼›æˆ¿é—´æ— å‡Œä¹±ç—•è¿¹ã€‚", provider: "prosecutor" },
                        { id: "E009", name: "åˆ˜æµ·æœˆè¯¢é—®ç¬”å½•", content: "åˆ˜æµ·æœˆæè¿°ï¼šå‡Œæ™¨ç¨‹æŒ¯è´¤å«å¸®å¿™å¼€æˆ¿ï¼Œæ‰¶é†‰é…’æœ‹å‹å…¥ä½åç¦»å¼€ï¼›ä¸Šåˆæˆ¿ä¸œé€šçŸ¥ï¼Œå‘ç°æ­»äº¡ã€‚", provider: "prosecutor" },
                        { id: "E010", name: "ç¨‹æŒ¯è´¤è¯¢é—®ç¬”å½•", content: "ç¨‹æŒ¯è´¤æè¿°ï¼šä¸å°é¾™ï¼ˆå¼ é¾™ï¼‰å–é…’åé©¾ç”µåŠ¨è½¦ç¢°æ’å°è´§è½¦ï¼Œå€’åœ°åé€å°é¾™è‡³æ—…åº—ä¼‘æ¯ï¼›ä¸Šåˆå‘ç°æ­»äº¡ã€‚", provider: "prosecutor" },
                        { id: "E011", name: "ç¨‹æŒ¯è´¤ç¬¬ä¸€æ¬¡è®¯é—®ç¬”å½•", content: "ç¨‹æŒ¯è´¤ä¾›è¿°ï¼šå–é…’ç»†èŠ‚ã€ç¢°æ’è¿‡ç¨‹ã€æœªé€åŒ»åŸå› ã€é€è‡³æ—…åº—ç»è¿‡ï¼›ä»¥ä¸ºé†‰é…’æœªå—ä¼¤ã€‚", provider: "prosecutor" },
                        { id: "E012", name: "ç¨‹æŒ¯è´¤ç¬¬äºŒæ¬¡è®¯é—®ç¬”å½•", content: "ç¨‹æŒ¯è´¤ä¾›è¿°ï¼šå–é…’é‡ã€ç¢°æ’ç»†èŠ‚ã€å°é¾™é†‰é…’çŠ¶æ€ã€æ£€æŸ¥ä¼¤åŠ¿ï¼›æ— æ‘©æ‰˜é©¾ç…§ã€‚", provider: "prosecutor" },
                        { id: "E013", name: "ç¨‹æŒ¯è´¤ç¬¬ä¸‰æ¬¡è®¯é—®ç¬”å½•", content: "ç¨‹æŒ¯è´¤ä¾›è¿°ï¼šæ‰¶å°é¾™è‡³æ—…åº—è¿‡ç¨‹ã€æœªé€åŒ»åŸå› ã€‚", provider: "prosecutor" },
                        { id: "E014", name: "ç¨‹æŒ¯è´¤ç¬¬å››æ¬¡è®¯é—®ç¬”å½•", content: "ç¨‹æŒ¯è´¤ä¾›è¿°ï¼šç¡®è®¤ç¢°æ’è‡´ä¼¤ã€æ¥å—é€®æ•ã€‚", provider: "prosecutor" },
                        { id: "E015", name: "ç°å‹˜ç…§ç‰‡å’Œå›¾è¡¨", content: "åŒ…æ‹¬æ—…é¦†æˆ¿é—´ç…§ç‰‡ã€è¡€è¿¹ã€ç°åœºè·¯å†µã€å°è´§è½¦åˆ®æ“¦ç—•è¿¹ã€å°¸ä½“ä½ç½®ç­‰è§†è§‰è¯æ®ã€‚", provider: "prosecutor" },
                        { id: "E016", name: "æ— ç½ªè¾©æŠ¤è¯ä¸»ä½“", content: "è¾©æŠ¤äººè®¤ä¸ºè¢«å‘Šæ— ç½ªï¼šæ— ä¸»è§‚è¿‡å¤±ã€æœªé¢„è§æ­»äº¡é£é™©ã€ç§¯ææ•‘åŠ©è¡Œä¸ºã€æ­»å› å¯èƒ½ä¸ºé†‰é…’æˆ–ä»–å› ï¼›å¼•ç”¨æ³•å¾‹å’Œç±»ä¼¼æ¡ˆä¾‹è®ºè¯ã€‚", provider: "defendant" }
                    ]
                });

                // è®¡ç®—å±æ€§
                const phaseDisplay = computed(() => {
                    const phaseMap = {
                        'opening': 'å¼€åº­é˜¶æ®µ',
                        'investigation': 'æ³•åº­è°ƒæŸ¥',
                        'debate': 'æ³•åº­è¾©è®º',
                        'verdict': 'å®£å¸ƒåˆ¤å†³'
                    };
                    return phaseMap[currentPhase.value] || currentPhase.value;
                });

                const phaseColor = computed(() => {
                    const colorMap = {
                        'opening': 'text-blue-400',
                        'investigation': 'text-yellow-400',
                        'debate': 'text-orange-400',
                        'verdict': 'text-purple-400'
                    };
                    return colorMap[currentPhase.value] || 'text-gray-400';
                });

                const progressBarColor = computed(() => {
                    if (progress.value < 25) return 'bg-blue-500';
                    if (progress.value < 50) return 'bg-yellow-500';
                    if (progress.value < 75) return 'bg-orange-500';
                    return 'bg-green-500';
                });

                const availableEvidence = computed(() => {
                    return trialData.value.evidence_list.filter(ev => ev.provider === 'prosecutor' || ev.provider === 'defendant');
                });

                // WebSocket æ–¹æ³•
                const connect = () => {
                    if (ws.value?.readyState === WebSocket.OPEN) return;

                    const wsUrl = 'ws://localhost:8000/ws/trial';
                    ws.value = new WebSocket(wsUrl);

                    ws.value.onopen = () => {
                        connected.value = true;
                        reconnectAttempts.value = 0;
                        addSystemMessage('å·²è¿æ¥åˆ°åº­å®¡æœåŠ¡å™¨');
                    };

                    ws.value.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            handleMessage(msg);
                        } catch (e) {
                            console.error('Failed to parse message:', e);
                        }
                    };

                    ws.value.onclose = () => {
                        connected.value = false;
                        threadId.value = null;
                        addSystemMessage('è¿æ¥å·²æ–­å¼€');
                        // è‡ªåŠ¨é‡è¿
                        if (reconnectAttempts.value < 5) {
                            reconnectTimer.value = setTimeout(() => {
                                reconnectAttempts.value++;
                                addSystemMessage(`å°è¯•é‡è¿... (${reconnectAttempts.value}/5)`);
                                connect();
                            }, 3000);
                        }
                    };

                    ws.value.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        error.value = 'è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ';
                    };
                };

                const disconnect = () => {
                    if (reconnectTimer.value) {
                        clearTimeout(reconnectTimer.value);
                    }
                    if (ws.value) {
                        ws.value.close();
                        ws.value = null;
                    }
                    connected.value = false;
                };

                const send = (msg) => {
                    if (ws.value?.readyState === WebSocket.OPEN) {
                        ws.value.send(JSON.stringify(msg));
                    }
                };

                // æ¶ˆæ¯å¤„ç†
                const handleMessage = (msg) => {
                    console.log('Received:', msg);

                    switch (msg.type) {
                        case 'session_created':
                            threadId.value = msg.data.thread_id;
                            addSystemMessage('åº­å®¡ä¼šè¯å·²åˆ›å»º');
                            break;

                        case 'node_executed':
                            currentNodeName.value = msg.data.node_name;
                            progress.value = msg.data.progress || 0;
                            currentPhase.value = msg.data.current_phase || '';

                            if (msg.data.focus) {
                                focus.value = msg.data.focus;
                            }
                            if (msg.data.rounds) {
                                rounds.value = msg.data.rounds;
                            }

                            // æ·»åŠ æ¶ˆæ¯
                            if (msg.data.messages) {
                                msg.data.messages.forEach(m => {
                                    addMessage(m, msg.data.node_name);
                                });
                            }
                            if (msg.data.state_delta?.latest_message) {
                                addMessage(msg.data.state_delta.latest_message, msg.data.node_name);
                            }
                            break;

                        case 'interrupt_request':
                            // ç¡®ä¿ node_name æ˜¯å­—ç¬¦ä¸²
                            if (Array.isArray(msg.data.node_name)) {
                                msg.data.node_name = msg.data.node_name[0];
                            }
                            interrupt.value = msg.data;
                            scrollToBottom();
                            break;

                        case 'trial_completed':
                            trialCompleted.value = true;
                            interrupt.value = null;
                            addSystemMessage('ğŸ‰ åº­å®¡å·²å®Œæˆï¼');
                            break;

                        case 'error':
                            error.value = msg.data.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯';
                            break;
                    }

                    lastMessageTime.value = new Date().toLocaleTimeString();
                    scrollToBottom();
                };

                // æ¶ˆæ¯æ·»åŠ 
                const addMessage = (msg, nodeName = null) => {
                    if (!msg) return;

                    // Extract content and name from message object
                    // msg can be either an object { content, name, type } or a string (for backward compatibility)
                    const content = msg.content || msg;
                    const name = msg.name;

                    // Determine role from message name field (primary method)
                    let role = 'system';
                    if (name && typeof name === 'string') {
                        if (name.includes('å®¡åˆ¤é•¿') || name.includes('æ³•å®˜')) role = 'judge';
                        else if (name.includes('å…¬è¯‰äºº') || name.includes('æ£€å¯Ÿå‘˜')) role = 'prosecutor';
                        else if (name.includes('è¢«å‘Šäºº')) role = 'defendant';  // è¢«å‘Šäºº
                        else if (name.includes('è¾©æŠ¤') || name.includes('å¾‹å¸ˆ')) role = 'defense_attorney';  // è¾©æŠ¤äºº
                        else if (name.includes('ä¹¦è®°å‘˜')) role = 'clerk';
                    } else {
                        // Fallback: determine role from nodeName or content analysis
                        if (nodeName) {
                            if (nodeName.includes('judge') || nodeName.includes('focus')) role = 'judge';
                            else if (nodeName.includes('pros')) role = 'prosecutor';
                            else if (nodeName.includes('defense') || nodeName.includes('defendant')) role = 'defense_attorney';
                            else if (nodeName.includes('clerk')) role = 'clerk';
                        }

                        // Fallback to content analysis
                        if (role === 'system' && typeof content === 'string') {
                            if (content.includes('å®¡åˆ¤é•¿') || content.includes('æ³•å®˜')) role = 'judge';
                            else if (content.includes('å…¬è¯‰äºº') || content.includes('æ£€å¯Ÿå‘˜')) role = 'prosecutor';
                            else if (content.includes('è¢«å‘Šäºº')) role = 'defendant';
                            else if (content.includes('è¾©æŠ¤') || content.includes('å¾‹å¸ˆ')) role = 'defense_attorney';
                            else if (content.includes('ä¹¦è®°å‘˜')) role = 'clerk';
                        }
                    }

                    messages.value.push({
                        role,
                        content: typeof content === 'string' ? content : JSON.stringify(content),
                        node_name: nodeName,
                        timestamp: Date.now()
                    });
                };

                const addSystemMessage = (content) => {
                    messages.value.push({
                        role: 'system',
                        content,
                        timestamp: Date.now()
                    });
                };

                // ç”¨æˆ·äº¤äº’
                const toggleTrial = () => {
                    if (!connected.value) {
                        connect();
                        return;
                    }

                    if (!trialStarted.value) {
                        startTrial();
                    } else if (trialCompleted.value) {
                        resetTrial();
                    }
                };

                const startTrial = () => {
                    trialStarted.value = true;
                    trialCompleted.value = false;
                    messages.value = [];
                    focus.value = [];
                    rounds.value = {};
                    progress.value = 0;

                    send({
                        type: 'start_trial',
                        data: {
                            case_info: trialData.value.meta,
                            evidence_list: trialData.value.evidence_list
                        }
                    });
                };

                const resetTrial = () => {
                    trialStarted.value = false;
                    trialCompleted.value = false;
                    messages.value = [];
                    focus.value = [];
                    rounds.value = {};
                    progress.value = 0;
                    currentPhase.value = '';
                    interrupt.value = null;
                };

                const sendInput = (input) => {
                    if (!interrupt.value || !threadId.value) return;

                    send({
                        type: 'user_input',
                        thread_id: threadId.value,
                        data: {
                            interrupt_node: interrupt.value.node_name,
                            input: input
                        }
                    });

                    interrupt.value = null;
                    stringInput.value = '';
                };

                const sendEvidenceInput = () => {
                    if (!interrupt.value || !threadId.value) return;

                    let currentEvidence;
                    if (evidenceShowType.value === 'quit') {
                        currentEvidence = null;
                    } else if (evidenceShowType.value === 'single' && selectedEvidence.value.length > 0) {
                        currentEvidence = selectedEvidence.value[0];
                    } else {
                        currentEvidence = selectedEvidence.value;
                    }

                    send({
                        type: 'user_input',
                        thread_id: threadId.value,
                        data: {
                            interrupt_node: interrupt.value.node_name,
                            input: {
                                current_evidence: currentEvidence,
                                messages: evidenceMessage.value || (evidenceShowType.value === 'quit' ? 'æ”¾å¼ƒä¸¾è¯' : '')
                            }
                        }
                    });

                    interrupt.value = null;
                    selectedEvidence.value = [];
                    evidenceMessage.value = '';
                };

                // UI è¾…åŠ©æ–¹æ³•
                const clearMessages = () => {
                    messages.value = [];
                };

                const scrollToBottom = async () => {
                    await nextTick();
                    if (messageContainer.value) {
                        messageContainer.value.scrollTop = messageContainer.value.scrollHeight;
                    }
                };

                const getRoleClass = (msg) => {
                    return `role-${msg.role}`;
                };

                const getRoleTextColor = (msg) => {
                    const colors = {
                        judge: 'text-amber-400',
                        prosecutor: 'text-blue-400',
                        defendant: 'text-green-400',
                        defense_attorney: 'text-orange-400',
                        clerk: 'text-gray-400',
                        system: 'text-purple-400'
                    };
                    return colors[msg.role] || 'text-gray-400';
                };

                const getRoleName = (msg) => {
                    const names = {
                        judge: 'ğŸ‘¨â€âš–ï¸ å®¡åˆ¤é•¿',
                        prosecutor: 'ğŸ‘” å…¬è¯‰äºº',
                        defendant: 'ğŸ‘¤ è¢«å‘Šäºº',
                        defense_attorney: 'ğŸ‘¨â€âš–ï¸ è¾©æŠ¤å¾‹å¸ˆ',
                        clerk: 'ğŸ“ ä¹¦è®°å‘˜',
                        system: 'ğŸ”” ç³»ç»Ÿ'
                    };
                    return names[msg.role] || 'ğŸ’¬';
                };

                const formatTime = (timestamp) => {
                    return new Date(timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                };

                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    connect();
                });

                onUnmounted(() => {
                    disconnect();
                });

                return {
                    // çŠ¶æ€
                    connected, threadId, trialStarted, trialCompleted,
                    messages, currentPhase, progress, focus, rounds,
                    currentNodeName, interrupt, stringInput, error,
                    selectedEvidence, evidenceShowType, evidenceMessage,
                    messageContainer, lastMessageTime, trialData,

                    // è®¡ç®—å±æ€§
                    phaseDisplay, phaseColor, progressBarColor, availableEvidence,

                    // æ–¹æ³•
                    toggleTrial, startTrial, resetTrial, clearMessages,
                    sendInput, sendEvidenceInput, scrollToBottom,
                    getRoleClass, getRoleTextColor, getRoleName, formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
